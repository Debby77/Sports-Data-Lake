name: AI Pull Request Reviewer

on:
  workflow_dispatch:        # Allows manual run
  pull_request:            # Also triggers on PRs
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get PR diff
        if: github.event_name == 'pull_request'
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          echo "DIFF<<EOF" >> $GITHUB_OUTPUT
          git diff origin/${{ github.base_ref }}..HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call OpenAI for Review
        if: github.event_name == 'pull_request'
        id: ai
        run: |
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d '{
              "model": "gpt-4.1-mini",
              "messages": [
                {"role": "system", "content": "You are a senior software engineer. Review the following PR diff for bugs, issues, and suggestions."},
                {"role": "user", "content": "Review this diff:\n${{ steps.diff.outputs.DIFF }}"}
              ]
            }'
          )
          echo "REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')" >> $GITHUB_OUTPUT

      - name: Post AI Review Comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ðŸ¤– **AI Code Review**
            ---
            ${{ steps.ai.outputs.REVIEW }}

      - name: Manual Run Demo
        if: github.event_name == 'workflow_dispatch'
        run: echo "Workflow triggered manually. PR comment feature works on pull requests."
